/*
可编辑插件
jquery.extgrid.edit.js
http://www.extgrid.com
author:nobo
qq:505931977
QQ交流群:13197510
email:zere.nobo@gmail.com or QQ邮箱
v1.0
*/
(function(e){"use strict";e.extGrid.puglins.push(function(){var e=this;e.bind("onBeforeShowGrid",function(){e.unEditCell()})});var t={text:function(t,n){var r=e(t.renderTo).extform(t).val(n);return r},textarea:function(t,n){var r=e(t.renderTo).extform(t).val(n);return r},date:function(t,n){var r=e(t.renderTo).extform(t).val(n);return r},checkbox:function(t,n){t.on==n&&n=="",t.items=[{name:t.on}];var r=e(t.renderTo).extform(t).val(n),i=r.val;return r.val=function(){var e=r,n=i.apply(e,arguments);return arguments.length?n:n==""?t.off:t.on},r},radio:function(t,n){var r=e(t.renderTo).extform(t).val(n);return r},spinner:function(t,n){var r=e(t.renderTo).extform(t).val(n);return r},select:function(t,n){var r=this,i=t.items;for(var s=0;s<i.length;s++){var o=i[s];o.name=typeof o.name=="undefined"?o.value:o.name,o.value=typeof o.value=="undefined"?o.name:o.value}var u=e(t.renderTo).extform(t);n!==""&&u.val(n.toString());var a=r.bind("onScroll",function(){u.hideSelect()});return u.bind("onDestroy",function(){r.unbind("onScroll",a)}),u},stagselect:function(t,n){var r=e(t.renderTo).extform(t).val(n);return r}};e.extGrid.fn.extend({editors:[],createEditor:function(n,r){var i=this,s=i.configs,o=i.getColumnData(r),u=o.editor;if(!u||e.isEmptyObject(u))return!1;var a=u.type||"text",f=a in t?!1:!0;if(f)return!1;var l=i.insertEditor(n,r);if(!l)return!1;var c=i.getFieldValue(n,r),h=s.id+"_"+n+"_"+r+"_edit",p=h+"_cell",d=s.id+"_"+r+"_row_"+n+"_cell",v=e("#"+d).width(),m=u.width||v;u.name=s.id+"_"+r+"_"+n,u.width=v,u.renderTo="#"+p,u.group=s.id;var g=t[a].call(i,u,c),y=i.editors;for(var b=0;b<y.length;b++)if(y[b].id==h){y[b].editorProvider=g;break}return y[b]},insertEditor:function(t,n){var r=this,i=r.configs,s=r.getColumnData(n);if(s==null)return!1;if(s.disabled)return!1;var o,u,a,f;o=r.inArray(t,i.lockRows)==-1?!1:!0,u=r.inArray(n,i.lockColumns)==-1?!1:!0,a=r.inArray(n,i.hideColumns)==-1?!1:!0;if(a)return!1;o&&u?f="datagrid-view1-header-outer-wraper-"+i.id:o?f="datagrid-view2-header-outer-wraper-"+i.id:u?f="view1-datagrid-body-"+i.id:f="view2-datagrid-body-"+i.id,f=e("#"+f);var l=i.id+"_"+n+"_row_"+t+"_td",c=e("#"+l),h=i.id+"_"+n+"_row_"+t+"_cell",p=e("#"+h),d,v,m;d=e("#"+l).offset(),v=f.offset(),m={left:d.left-v.left+i.sLeft,top:d.top-v.top+i.sTop};var g=i.id+"_"+t+"_"+n+"_edit";if(e("#"+g).length)return e("#"+g);var y=g+"_cell",b=e("<table cellpadding=0 cellspacing=0 id='"+g+"'><tr><td id='"+y+'\' valign="middle" align="center" ></td></tr></table>');b.click(function(e){e.stopPropagation()});var w=s.editor,E=w.width?parseFloat(w.width):0,S=w.height?parseFloat(w.height):0;b.addClass("edit-cell"),b.css({width:c.outerWidth(),height:Math.max(S,c.outerHeight()),left:m.left,position:"absolute",top:m.top}),b.appendTo(f);var x={id:g,rid:t,field:n,viewValue:p.html(),editor:b};return r.editors.push(x),b},removeEditor:function(t,n,r){var i=this,s=i.configs,r=r||!1,o=s.id+"_"+t+"_"+n+"_edit",u=o+"_cell",a=!1,f=!1,l=i.editors;for(var c=0;c<l.length;c++)if(l[c].id==o){l[c].editorProvider._destroy(),a=l[c].viewValue,l.splice(c,1),f=!0;break}e("#"+o).remove();if(r&&f&&a!==!1){var h=s.id+"_"+n+"_row_"+t+"_cell",p=e("#"+h);p.size()&&p.html(a)}return i},getEditCellValue:function(e,t){var n=this,r=n.configs,i=n.editors,s="";for(var o=0;o<i.length;o++)if(i[o].rid==e&&i[o].field==t){s=i[o].editorProvider.val();break}return s},checkEditCell:function(e,t){var n=this,r=n.configs,i=n.editors,s=!0;for(var o=0;o<i.length;o++)if(i[o].rid==e&&i[o].field==t){var u=i[o].editorProvider.checkVal();u===!1&&(s=!1);break}return s},editCell:function(t,n){var r=this,i=r.configs,s=i.id+"_"+n+"_row_"+t+"_cell",o=e("#"+s);if(!o.size())return!1;var u=r.createEditor(t,n);if(!u)return!1;o.empty()},saveEditCell:function(e,t){var n=this,r=n.configs,i=n.editors,s=i.length,o=o||!1,u=[];if(arguments.length==2)for(var a=0;a<s;a++){var f=i[a];if(f.rid==e&&f.field==t){var l=f.editorProvider.checkVal(),c=f.editorProvider.val();n.removeEditor(f.rid,f.field,!0);if(l===!1)break;var h=n.setFieldValue(f.rid,f.field,c);h!==!1&&u.push({rid:f.rid,field:f.field});break}}else for(var a=0;a<s;){var f=i[a],l=f.editorProvider.checkVal(),c=f.editorProvider.val();n.removeEditor(f.rid,f.field,!0),s=i.length;if(l===!1)continue;var h=n.setFieldValue(f.rid,f.field,c);h!==!1&&u.push({rid:f.rid,field:f.field})}return u},unEditCell:function(e,t){var n=this,r=n.configs;if(arguments.length==2)n.removeEditor(e,t,!0);else{var i=n.editors,s=i.length;for(var o=0;o<s;){var u=i[o];n.removeEditor(u.rid,u.field,!0),s=i.length}}},editRow:function(t){var n=this,r=n.configs,i=n.getColumns();e.each(i,function(e,r){n.editCell(t,r.field)})},checkEditRow:function(e){var t=this,n=t.configs,r=t.editors,i=[],s=!0;for(var o=0;o<r.length;o++){if(r[o].rid!=e)continue;var u=t.checkEditCell(e,r[o].field);u===!1&&(s=u)}return s},saveEditRow:function(e){var t=this,n=t.configs,r=t.editors,i=[],s=[];for(var o=0;o<r.length;o++){if(r[o].rid!=e)continue;s.push({rid:e,field:r[o].field})}for(var u=0;u<s.length;u++){var a=t.saveEditCell(e,s[u].field);a.length&&i.push(s[u].field)}var f=t.getRowData(e);t.fireEvent("onRowEdit",[e,f,i])},unEditRow:function(t){var n=this,r=n.configs,i=n.getColumns();e.each(i,function(e,r){n.unEditCell(t,r.field)})}})})(jQuery);